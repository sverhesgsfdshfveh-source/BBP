# Browser Bridge Plus：内容读取与 Token 提取补齐路线图（任务看板）

日期：2026-02-20  
范围：仅设计与任务拆分（本文件不包含代码实现）

---

## 目标

在现有多 client / 多 tab relay 底座已可用的前提下，补齐“读取 tab 正文内容 → 提取 token/兑换码”的能力链路，支持后续自动筛查可用信息。

---

## 当前状态（简述）

已具备：
- relay 核心状态机与重连机制
- clients/tabs/status API
- 控制台指标与分组视图
- 单元/集成/e2e 基础测试矩阵

尚缺失：
- 面向指定 tab 的正文读取能力（DOM/可见文本）
- 基于正文的 token/key 提取与风险分组

---

## 任务看板（按优先级）

### T1｜内容读取接口设计（0.5 天）

**输出物**
- `readTabContent` 接口草案（入参/出参/错误码/安全边界）

**建议字段**
- 入参：`clientId`（可选）、`tabId`（可选，默认 active）、`maxChars`（可选）
- 出参：`url` / `title` / `text` / `links[]` / `timestamp`

**安全边界**
- 仅允许读取已连接客户端的已授权标签页
- 默认不返回 cookies/localStorage/sessionStorage 等敏感数据
- 限制单次返回长度，避免大对象与潜在泄露

**验收标准**
- 字段满足抓取需求且风险可控

---

### T2｜扩展侧读取能力方案（0.5 天）

**输出物**
- MV3 场景下的读取方案说明（技术路径与限制清单）

**需要明确**
- 从指定 tab 获取“可见文本”的实现路径
- 受保护页面（如 Cloudflare challenge）预期失败行为
- 长文截断策略、编码处理、链接提取策略

**验收标准**
- 支持范围与失败边界定义清晰，可直接进入开发

---

### T3｜Server API 契约与路由设计（0.5 天）

**输出物**
- 请求流程图（API → relay → extension → 回传）
- 错误映射表（无权限/无此 tab/超时/断连/页面不可读）

**重点**
- 多 client 并发下不串 tab
- 断线与超时行为可预测

**验收标准**
- 契约可测试、可观测、可回归

---

### T4｜可观测性与诊断项（0.5 天）

**输出物**
- 指标清单与 status 摘要扩展设计

**建议新增指标**
- `content_read_total`
- `content_read_success_total`
- `content_read_fail_total{reason}`

**建议 reason 枚举**
- `unauthorized`
- `tab_not_found`
- `client_offline`
- `timeout`
- `protected_page`
- `internal_error`

**验收标准**
- status 中可看到最近失败原因 TopN，便于排障

---

### T5｜最小验收测试清单（0.5 天）

**输出物**
- 可执行测试场景文档（输入/期望/失败判据）

**最小 5 场景**
1. 普通公开页面可读
2. Cloudflare/受保护页返回明确失败
3. 多 client 并发读取不串号
4. 长页面截断与 `maxChars` 生效
5. 断线重连后恢复读取能力

**验收标准**
- 5 条全部可复现且可自动化

---

### T6｜Token 提取规则（0.5 天）

**输出物**
- 规则文档（正则模式、去重、打分、风险分组）

**分组标准（初版）**
- 疑似可用：格式合法 + 上下文含“可用/刚测可用/今日可用”等
- 疑似过期：上下文含“失效/过期/已封/不可用”等
- 高风险：疑似钓鱼链接、异常短链、诱导执行脚本、泄露凭据风险

**结果要求**
- 每条记录强制附：`sourceUrl`、`capturedAt`、`confidence`、`reason`

**验收标准**
- 输出可审计、可追溯，不做未授权验证动作

---

## 里程碑建议

- M1（Day 1）：T1 + T2
- M2（Day 2）：T3 + T4
- M3（Day 3）：T5 + T6

完成 M2 后即可进入最小开发闭环；完成 M3 后可进入灰度试跑。

---

## 非目标（本阶段不做）

- 不做绕过反爬/验证码/登录态破解
- 不做自动提交、兑换、激活等外部动作
- 不做跨站高权限抓取

---

## 风险与依赖

- 目标站点防护策略变化（Cloudflare 等）
- 扩展权限与 MV3 限制
- 多 client 并发场景下的消息时序一致性

建议优先保障：可观测性 > 功能覆盖 > 性能优化。
