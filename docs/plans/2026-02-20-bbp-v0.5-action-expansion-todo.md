# BBP v0.5 Action 扩展清单与可执行 TODO

日期：2026-02-20  
状态：In Progress（P0 首批动作已实现，待继续完善）  
目标：在 v0/v1.1 基础上扩展“预定义动作”能力，减少 runJs 依赖，提升稳定性与可维护性。

> 重点：`screenshotTab`（截图回传）优先级上调到 P0，服务前端开发/页面结构分析场景。

---

## 0. 通用约定（所有 Action）

### 请求公共字段
- `clientId: string`（必填）
- `tabId: string`（多数动作必填；`openTab` 可选）
- `action: string`（必填）
- `params: object`（可选）
- `timeoutMs: number`（可选，默认 8000）
- `mode: "api" | "auto" | "runJs"`（可选，v0.5 新动作建议固定 `api`）

### 统一响应结构
```json
{
  "ok": true,
  "requestId": "req_xxx",
  "result": {
    "ok": true,
    "action": "<action>",
    "tabId": "<tab-id>",
    "data": {},
    "meta": {
      "action": "<action>",
      "tabId": "<tab-id>",
      "durationMs": 12
    }
  }
}
```

### 通用错误码
- `execution_disabled`
- `client_not_found`
- `tab_not_found`
- `domain_not_allowed`
- `protected_page`
- `invalid_params`
- `timeout`
- `script_runtime_error`
- `unsupported_action`
- `unsupported_fallback_action`
- `internal_error`

### 命名规范（新增）
- 统一使用 `*Selector` 后缀的交互动作命名：`clickSelector` / `typeSelector`
- 保留别名兼容（如历史 `click` / `type`），但文档与新开发以标准命名为准

---

## 1. P0（第一批，立即实现）

## 1.1 `openTab`
**作用**：打开新标签页。

**入参**：
- `params.url: string`（必填）
- `params.active?: boolean`（默认 true）
- `params.windowId?: number`

**出参**：
- `data.tabId: string`
- `data.url: string`
- `data.windowId: number`

**错误码**：
- `invalid_params`（url 缺失或非法）
- `internal_error`

**TODO**：
- [x] action_executor 实现 `openTab`
- [x] 返回新 tab 元信息
- [x] 加 1 条联调样例

---

## 1.2 `focusTab`
**作用**：切换聚焦到目标标签页。

**入参**：
- `tabId: string`（必填）

**出参**：
- `data.tabId: string`
- `data.active: true`

**错误码**：
- `tab_not_found`
- `internal_error`

**TODO**：
- [x] 调用 `chrome.tabs.update({active:true})`
- [ ] 可选同步窗口聚焦

---

## 1.3 `closeTab`
**作用**：关闭指定标签页。

**入参**：
- `tabId: string`（必填）

**出参**：
- `data.closed: true`
- `data.tabId: string`

**错误码**：
- `tab_not_found`
- `internal_error`

**TODO**：
- [x] 调用 `chrome.tabs.remove`
- [ ] 处理已关闭 id 的幂等返回

---

## 1.4 `clickSelector`
**作用**：按 CSS 选择器点击元素。

**入参**：
- `params.selector: string`（必填）
- `params.timeoutMs?: number`

**出参**：
- `data.clicked: true`
- `data.selector: string`

**错误码**：
- `invalid_params`
- `script_runtime_error`（元素不存在/不可点击）
- `timeout`

**TODO**：
- [x] selector_utils 增加定位与可点击性检查
- [x] 支持等待后点击

---

## 1.5 `typeSelector`
**作用**：按选择器输入文本。

**入参**：
- `params.selector: string`（必填）
- `params.text: string`（必填）
- `params.append?: boolean`（默认 false）

**出参**：
- `data.typed: true`
- `data.length: number`

**错误码**：
- `invalid_params`
- `script_runtime_error`

**TODO**：
- [x] 支持 input/textarea/contenteditable
- [x] 默认触发 input/change 事件

---

## 1.6 `waitForSelector`
**作用**：等待元素出现。

**入参**：
- `params.selector: string`（必填）
- `params.timeoutMs?: number`（默认继承请求超时）

**出参**：
- `data.found: true`
- `data.selector: string`

**错误码**：
- `invalid_params`
- `timeout`

**TODO**：
- [x] 轮询/MutationObserver 二选一实现
- [x] 统一超时错误码

---

## 1.7 `waitForText`
**作用**：等待页面出现指定文本。

**入参**：
- `params.text: string`（必填）
- `params.timeoutMs?: number`
- `params.gone?: boolean`（默认 false，true=等待文本消失）

**出参**：
- `data.matched: true`
- `data.text: string`

**错误码**：
- `invalid_params`
- `timeout`

**TODO**：
- [x] 支持 `gone` 模式
- [x] 结果中返回命中片段

---

## 1.8 `querySelectorAttr`
**作用**：读取元素属性值。

**入参**：
- `params.selector: string`（必填）
- `params.attr: string`（必填，如 `href/src/value`）
- `params.all?: boolean`（默认 false）

**出参**：
- `data.value: string | string[]`

**错误码**：
- `invalid_params`
- `script_runtime_error`

**TODO**：
- [x] 单值/多值统一包装
- [x] 空值与不存在区分

---

## 1.9 `screenshotTab`（重点）
**作用**：截图并回传（前端开发/页面结构分析高频使用）。

**入参**：
- `tabId: string`（必填）
- `params.fullPage?: boolean`（v0.5 可先忽略，默认 false）
- `params.format?: "png" | "jpeg"`（默认 `png`）
- `params.quality?: number`（jpeg 可选）

**出参**：
- `data.imageBase64: string`（统一使用 imageBase64，不再使用 imageDataUrl）
- `data.format: string`
- `data.width?: number`
- `data.height?: number`
- `data.url?: string`
- `data.title?: string`
- `data.capturedAt?: number`

**错误码**：
- `tab_not_found`
- `protected_page`
- `internal_error`

**TODO**：
- [x] 使用 `chrome.tabs.captureVisibleTab` 实现首版
- [x] 首版不设置 maxBytes 限制，直接回传 `imageBase64`
- [x] 增加“截图+当前 URL/title/capturedAt”联动返回
- [x] 写一条联调示例：截图后直接用于页面结构分析

---

## 2. P1（第二批，增强稳定性）

## 2.1 `extractTable`
**作用**：结构化提取表格。

**入参**：
- `params.selector?: string`（默认首个 table）

**出参**：
- `data.headers: string[]`
- `data.rows: string[][]`

**错误码**：
- `invalid_params`
- `script_runtime_error`

**TODO**：
- [ ] 支持 thead/tbody 兼容

---

## 2.2 `extractForms`
**作用**：提取页面表单字段定义。

**入参**：
- `params.selector?: string`

**出参**：
- `data.forms: [{selector, fields:[{name,type,required,placeholder}]}]`

**错误码**：
- `script_runtime_error`

**TODO**：
- [ ] 字段标准化模型

---

## 2.3 `scrollTo`
**作用**：滚动到页面位置或元素。

**入参**：
- `params.y?: number`
- `params.selector?: string`
- 二选一

**出参**：
- `data.scrolled: true`

**错误码**：
- `invalid_params`
- `script_runtime_error`

**TODO**：
- [ ] 支持 smooth/instant 选项

---

## 2.4 `getTabMeta`
**作用**：读取 tab 元信息与页面就绪状态。

**入参**：
- `tabId: string`

**出参**：
- `data.url`
- `data.title`
- `data.status`
- `data.readyState`

**错误码**：
- `tab_not_found`

**TODO**：
- [ ] 与 screenshot 联动用于调试快照

---

## 3. P2（第三批，体验增强）

- `pressKey`
- `selectOption`
- `hoverSelector`
- `extractByRegex`
- `listInteractiveElements`

> TODO 规则同上：每项补齐入参/出参/错误码，再实现。

---

## 4. 权限与模式说明（补充）

- [ ] 明确 `mode=api` 是否受 v1(runJs) 开关控制（当前实现与文档需一致化）
- [ ] 明确 API 动作与 runJs 能力映射关系（避免误解）
- [ ] 双 client 场景保持可预测：
  - 开 v1 client：`runJs/api/auto` 按模式执行
  - 未开 v1 client：`action=runJs` 仍返回 `super_mode_disabled`

---

## 5. 联调与验收

### 最小验收标准
- [ ] P0 全部 action 可调用
- [ ] 两 client 并发场景不串 tab
- [ ] protected page 返回稳定错误码
- [ ] `screenshotTab` 可稳定回传并可用于页面结构分析
- [ ] v0/v1.1 既有能力无回归

### 建议联调脚本
- [ ] `scripts/smoke-plus.mjs` 增加 P0 动作用例
- [ ] 增加 `screenshotTab` 专项 smoke

---

## 5. 实施顺序（建议）

- M1（半天）：`openTab/focusTab/closeTab`
- M2（半天）：`clickSelector/typeSelector/waitForSelector/waitForText`
- M3（半天）：`querySelectorAttr/screenshotTab`（重点）
- M4（半天）：回归与文档示例

---

## 6. 备注

- 本计划遵循“个人高效优先”，但保留最小边界：allowlist/protected page。
- `runJs` 保留为可选能力，推荐主流程迁移到 API 动作流。
